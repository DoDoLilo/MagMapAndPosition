# MagMapAndPosition系统精度影响因素实验文档V0.1
## 1、本文档对应测试\实验目的
**NOTE**:该文档对应测试的目的**并非**单元测试代码BUG，更偏向于做**实验**。  
目的是测试出不同参数设置对该系统定位匹配结果的影响。毕竟不可能在实验前面面俱到，所以需要不断同步更新该文档。
### 测试参数（自变量）
#### 建库阶段参数：
|测试参数|参数说明|如何测试|测试范围|测试粒度|
|----|----|----|----|----|
|1. 建库块大小|BLOCK_SIZE：正方形块的边长。浮点，单位(m)。|
|2. 建库磁强低通滤波程度|EMD_FILTER_LEVEL: 低通滤波的程度，值越大舍弃的高频信号越多。整型，无单位。|
|3. 删除多余内插块的程度|DELETE_LEVEL：越大删除的内插块越多，可以为负值。整型，单位（块）。|
|4. 建库是否进行垂直水平分量|测试将磁强（1维）分为水平、垂直分量（2维）是否真的是正优化。|对比1维磁强建库（TODO）、2维磁强建库匹配的效果|
#### 匹配阶段参数：
|测试参数|参数说明|如何测试|测试范围|测试粒度|
|----|----|----|----|----|
|1. 不同PDR匹配轨迹|PDR坐标频率20Hz/s，传感器采样频率200Hz/s：1帧PDR坐标对应10帧传感器数据|
|+ PDR的准确度高低|PDR轨迹和iLocator之间的距离计算PDR的准确度|
|+ 测试轨迹的复杂度|转弯数量越多、越密，复杂度越高|
|+ 测试轨迹与建库轨迹的吻合度|PDR轨迹和建库的iLocator轨迹之间的距离计算吻合度|
|2. 缓冲池长度|BUFFER_DIS：单次匹配使用的轨迹长度，浮点，单位(m)|
|3. 最大迭代次数|MAX_ITERATION：高斯牛顿最大迭代次数，和“迭代步长”相关|
|4. 迭代步长|STEP：梯度下降的步长。其减小，MAX_ITERATION应增加(但暂不清楚二者关系)|
|5. 初始遍历搜索参数（粒度+次数）|START_CONFIG：[[△x,△y,△θ],[次数,次数,次数]]2×3数组|
|+ 粒度|单位(m和°)：粒度越细，相同次数，搜索区域越小；NOTE:粒度太小，则可能和高斯牛顿迭代区域重复？|
|+ 次数|次数越多，相同粒度下，搜索的范围越广。NOTE：角度重复(10°时最多±18次)|
|6. 是否在中间的匹配失败的时候进行遍历搜索| 进行遍历搜索：向暴力搜索求助|
|+ 遍历搜索参数（次数+粒度）|同5
|+ 是否和初始遍历搜索参数一致|按参考论文，中间搜索应该比初始搜索更轻量|
|7. 目标损失大小|TARGET_LOSS：loss达到该值则表示匹配成功提前结束高斯牛顿迭代。所以，该值越大，越容易匹配“成功”，高斯牛顿影响越小|
|+loss的计算函数？|这个目前无法修改，修改了loss计算公式，则整个高斯牛顿迭代公式都得改|
|8. 下采样距离大小|DOWN_SIP_DIS：在缓冲池产生匹配序列时，会对20Hz/s的PDR进行按距离下采样。|
|+ 等于建库块大小|... ...
|+ 小于建库块大小|如果下采样距离 < PDR在1/20秒内（相邻点）移动的距离，则不需要再减小测试了。|
|+ 大于建库块大小|... ...
|9. 匹配磁强低通滤波程度| EMD_FILTER_LEVEL: 低通滤波的程度，值越大舍弃的高频信号越多。整型，无单位。|
|+ 是否和建库滤波一致| 主要看建库采集的磁场和匹配时采集的磁场信号是否有区别？唯一区别就是建库的可能是多个文件平均的吧|

### 统计指标（因变量）
|指标|说明|如何计算|存储数据结构|表现形式|
|---|----|-------|-----------|-------|
|1. 匹配结果（坐标序列）与iLocator、PDR的总体距离：|单位（m）|①将iLocator坐标系转至MagMap坐标系；②对齐iLocator和PDR序列(1:10)；③两坐标(x,y)欧氏距离|
|+ 单点距离| | |statisticsDataBase[PDR_index, iL_index, Distance, PDR_x,PDR_y,iL_x,iL_y]（如果有时间，设计个MySql数据库存储数据就好了）|折线图|  
|+ 总和距离| |Sum(单点距离数组) |单浮点数|
|+ 平均距离| |总和距离/统计坐标数 |单浮点数|
|2. 匹配结果与与iLocator、PDR的分段距离：
|+ 总和距离| |记录段的起始、结束下标，从1.statisticsDataBase中即可计算获取|
|+ 平均距离| |总和距离/统计坐标数|
|+ 单点距离| |记录下标，从1.statisticsDataBase映射即可。|同statisticsDataBase形式|
|3. 初始遍历搜索成功与否|记录第一条匹配轨迹遍历搜索是否成功|
|+ 失败的原因|
|4. 中间匹配成功率|记录每次匹配是否成功|匹配成功的轨迹数量/匹配轨迹总数 |
|+ 失败的原因|越界or达到迭代次数上限|
|+ 失败后遍历搜索的成功与否|
|5. 系统所需迭代次数|记录每次匹配的高斯牛顿的迭代次数| | |
|+ 匹配成功的迭代次数|
|+ 匹配失败的迭代次数|
|6. 匹配耗时|记录系统运行的时间|
|+ 全轨迹总和耗时|Sum(单条序列耗时)|
|+ 单条序列耗时|记录单次匹配的耗时| | 
|+ 单点耗时|实际不存在，总耗时/点数得到|
|7. 建库耗时|记录不同参数下搭建地磁库的耗时，不怎么重要，因为是预处理的时间|

## 2、测试程序
**NOTE**: 测试程序、数据、结果文件均保存在 /test 目录下 

### 测试程序编写时应尽可能实现以下原则
+ 主要目的非代码BUG单元测试，所以不涉及BCDE原则
+ A：Automatic（自动化）
+ I：Independent（独立性），即做好控制变量
+ R：Repeatable（可重复）
+ 对于单元测试，要保证测试粒度足够小，有助于精确定位问题

### 添加的测试函数
1. 计算运行时间的函数
2. 计算两条未对齐之间的xy序列各点之间的距离（返回各个点的距离和坐标，如何进一步统计交给外层）
3. 记录匹配成功率

## 3、实验结果
NOTE:实验结果记录应由编写的测试程序，自动输出为文件记录。使用excel存储、统计数据。

单条实验记录=实验序号/实验时间+实验变量+控制变量+实验结果(统计指标)